<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Task</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      body {
        margin: 0;
        position: relative;
      }

      .nav-space {
        margin: 0 20px;
      }
      .nav-item:hover {
        background-color: #96c7c1;
        color: black;
      }
      .content {
        margin: 10px 20px;
        max-height: 100%;
        max-width: 100%;
        /* background-color: darkseagreen; */
      }
      #btn {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 150px;
      }

      button:hover {
        border-color: darkblue;
        color: darkblue;
      }
      .row1 {
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        margin: 10px;
        /* padding: 10px; */
      }
      .row2 {
        display: flex;
        align-items: center;
        justify-content: center;
        padding-right: 10px;
      }

      .div2 {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: left;
        margin: 0 10px;
      }
      .form-div {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: left;
        width: 600px;
      }
      p {
        font-size: 14px;
        font-weight: 400;
      }
      #userInfo {
        position: absolute;
        right: 5px;
        justify-content: right;
        font-size: 17px;
        font-weight: 400;
      }
    </style>
  </head>
  <body onload="lstorage();">
    <nav
      class="navbar navbar-expand-sm bg-dark container-fluid navbar-dark center"
    >
      <ul class="navbar-nav">
        <li class="nav-item nav-space">
          <a href="./taskhome.html" class="nav-link">Home</a>
        </li>
        <li class="nav-item nav-space">
          <a href="#" class="nav-link">Task</a>
        </li>
        <li class="nav-item nav-space">
          <a href="#" class="nav-link">DasshBoard</a>
        </li>
        <li class="nav-item nav-space">
          <a href="./tasksheduling.html" class="nav-link">Task Schedule</a>
        </li>
        <li class="nav-item nav-space">
          <a href="./index.html" onclick="removeUserInfo();" class="nav-link"
            >Logout</a
          >
        </li>
      </ul>
      <span id="userInfo" class="navbar-brand"></span>
    </nav>
    <form id="form">
      <div class="container p-5 my-5 border mt-3 form-div">
        <label for="title" class="form-label">Title</label>
        <input
          type="text"
          id="title"
          placeholder="Title"
          class="form-control"
          required
        />
        <p id="titleError" class="invalid-feedback">Title is required field</p>

        <label for="des" class="form-label">Description</label>
        <textarea
          class="form-control"
          id="des"
          cols="30"
          rows="5"
          placeholder="Description"
        >
        </textarea>
        <p id="desError" class="invalid-feedback">
          Description is required field
        </p>
        <div class="row1">
          <div class="div2">
            <label for="duedate" class="form-label">Due Date</label>
            <input type="date" id="dueDate" />
            <p id="dueError" class="invalid-feedback">
              DueDate is required field and must be greater than today
            </p>
            <label for="priority" class="form-label">Priority</label>
            <select class="form-select" name="priority" id="priority">
              <option value="" disabled selected hidden>Priority</option>
              <option value="1">High</option>
              <option value="2">Medium</option>
              <option value="3">Low</option>
            </select>
            <p id="priorError" class="invalid-feedback">
              Priority is required field
            </p>
          </div>
          <div class="div2">
            <div class="row2" id="type">
              <label class="form-check-label">Type</label>
              <div class="form-check row1">
                <input
                  type="radio"
                  class="form-check-input"
                  id="type1"
                  name="type"
                  value="1"
                />
                <label class="form-check-label" for="type1"> Task </label>
              </div>
              <div class="form-check row1">
                <input
                  type="radio"
                  class="form-check-input"
                  id="type2"
                  name="type"
                  value="2"
                />
                <label class="form-check-label" for="type2"> Story </label>
              </div>
              <div class="form-check row1">
                <input
                  type="radio"
                  class="form-check-input"
                  id="type3"
                  name="type"
                  value="3"
                />
                <label class="form-check-label" for="type3"> Bug</label>
              </div>
            </div>
            <p id="typeError" style="visibility: hidden; color: #cd1818">
              Select Type
            </p>
            <div id="box">
              <label class="form-check-label">Label</label>
              <div class="form-check">
                <input
                  id="ch1"
                  type="checkbox"
                  class="form-check-input checkbox"
                  name="label[]"
                  value="1"
                />
                <label class="form-check-label">Feature</label>
              </div>
              <div class="form-check">
                <input
                  id="ch2"
                  type="checkbox"
                  class="form-check-input checkbox"
                  name="label[]"
                  value="2"
                />
                <label class="form-check-label">Front-End</label>
              </div>
              <div class="form-check">
                <input
                  id="ch3"
                  type="checkbox"
                  class="form-check-input checkbox"
                  name="label[]"
                  value="3"
                />
                <label class="form-check-label">Change Request</label>
              </div>
              <div class="form-check">
                <input
                  id="ch4"
                  type="checkbox"
                  class="form-check-input checkbox"
                  name="label[]"
                  value="4"
                />
                <label class="form-check-label">Back-End</label>
              </div>
            </div>
            <p id="labelError" style="visibility: hidden; color: #cd1818">
              Min one Label is required
            </p>
          </div>
        </div>
        <div id="btn">
          <button class="btn" type="reset">Reset</button>
          <button class="btn" id="save" type="button">Save</button>
        </div>
      </div>
    </form>

    <script>
      let userName = localStorage.getItem("firstName");
      let userEmail = localStorage.getItem("email");
      let userInfo = document.getElementById("userInfo");
      userInfo.innerHTML = `Hello ${userName} (${userEmail})`;
      function lstorage() {
        if (localStorage.getItem("accessToken") !== null) {
          if (localStorage.getItem("Id") !== null) {
            document.getElementById("title").value =
              localStorage.getItem("title");
            document.getElementById("des").value = localStorage.getItem("des");
            var today = new Date(localStorage.getItem("due"));
            if (today.getDate() < 10)
              var formattedtoday =
                today.getFullYear() +
                "-" +
                (today.getMonth() + 1) +
                "-" +
                "0" +
                today.getDate() +
                1;
            else
              var formattedtoday =
                today.getFullYear() +
                "-" +
                (today.getMonth() + 1) +
                "-" +
                today.getDate() +
                1;
            document.getElementById("dueDate").value = formattedtoday;

            document.getElementById("priority").value =
              localStorage.getItem("priority");
            let rdo = localStorage.getItem("type");
            if (rdo == 1) document.getElementById("type1").checked = true;
            else if (rdo == 2) document.getElementById("type2").checked = true;
            else document.getElementById("type3").checked = true;

            for (i = 0; i < 4; i++) {
              if (localStorage.getItem("label")[i] == 1)
                document.getElementById("ch1").checked = true;
              else if (localStorage.getItem("label")[i] == 2)
                document.getElementById("ch2").checked = true;
              else if (localStorage.getItem("label")[i] == 3)
                document.getElementById("ch3").checked = true;
              else if (localStorage.getItem("label")[i] == 4)
                document.getElementById("ch4").checked = true;
            }
          }
        } else location.replace("./tasklogin.html");
      }
      function removels() {
        localStorage.removeItem("title");
        localStorage.removeItem("des");
        localStorage.removeItem("due");
        localStorage.removeItem("label");
        localStorage.removeItem("type");
        localStorage.removeItem("Id");
        localStorage.removeItem("priority");
      }

      let save = document.getElementById("save");

      save.addEventListener("click", savefun, true);
      let title = document.getElementById("title");
      let des = document.getElementById("des");
      let due = document.getElementById("dueDate");
      let priority = document.getElementById("priority");
      let label = document.getElementsByName("label[]");
      let labelDiv = document.getElementById("box");
      let typeDiv = document.getElementById("type");

      let titleError = document.getElementById("titleError");
      let desError = document.getElementById("desError");
      let dueError = document.getElementById("dueError");
      let priorError = document.getElementById("priorError");
      let labelError = document.getElementById("labelError");
      let typeError = document.getElementById("typeError");

      title.addEventListener("blur", validateTitle);
      des.addEventListener("blur", validateDes);
      due.addEventListener("blur", validateDue);
      priority.addEventListener("blur", validatePrior);
      labelDiv.addEventListener("click", validateLabel);

      function validateTitle() {
        if (title.value.trim() == "") {
          error(title, titleError);
          return false;
        } else {
          valid(title, titleError);
          return true;
        }
      }

      function validateDes() {
        if (des.value.trim() == "") {
          error(des, desError);
          return false;
        } else {
          valid(des, desError);
          return true;
        }
      }

      function validateDue() {
        let d = new Date();
        check_date =
          d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate();
        if (due.value == "" || due.value < check_date) {
          error(due, dueError);
          return false;
        } else {
          valid(due, dueError);
          return true;
        }
      }

      function validatePrior() {
        if (priority.value == "") {
          error(priority, priorError);
          return false;
        } else {
          valid(priority, priorError);
          return true;
        }
      }
      function validateLabel() {
        let count = 0;
        for (var i = 0; i < 4; i++) {
          if (label[i].checked) {
            count = 1;
          }
        }
        if (count == 0) {
          labelError.style.visibility = "visible";
          // error(label,labelError)
          return false;
        } else {
          labelError.style.visibility = "hidden";
          // valid(label,labelError)
          return true;
        }
      }
      function validateType() {
        let type = document.querySelector('input[name="type"]:checked');
        try {
          if (type.value == null) {
            typeError.style.visibility = "visible";
          } else typeError.style.visibility = "hidden";
        } catch {
          typeError.style.visibility = "visible";
          return false;
        }
      }

      function savefun() {
        let type = document.querySelector('input[name="type"]:checked');
        let Id = localStorage.getItem("Id");
        let checkedValue = [];
        let count = 0;
        let k = 0;
        for (var i = 0; i < 4; i++) {
          if (label[i].checked) {
            checkedValue[k] = label[i].value;
            count = 1;
            k++;
          }
        }
        validateTitle();
        validateDes();
        validateDue();
        validatePrior();
        validateType();
        validateLabel();
        if (
          validateTitle() == true &&
          validateDes() == true &&
          validateDue() == true &&
          validatePrior() == true
        ) {
          let jsonBody = {
            title: title.value,
            description: des.value,
            dueDate: due.value,
            label: checkedValue,
            priority: priority.value,
            type: type.value,
          };
          if (Id == null) {
            let config = {
              method: "POST",
              body: JSON.stringify(jsonBody),
              headers: {
                "Content-type": "application/json",
                Authorization: localStorage.getItem("accessToken"),
              },
            };

            fetch(
              "https://task-management-rest-app.herokuapp.com/api/tasks",
              config
            )
              .then((res) => res.json())
              .then((data) => {
                console.log(data);
                document.getElementById("form").reset();
                remove_valid_class();
                setTimeout(alert("Task Created"), 1000);
              })
              .catch((e) => alert(e.message));
          } else {
            let configPut = {
              method: "PUT",
              body: JSON.stringify(jsonBody),
              headers: {
                "Content-type": "application/json",
                Authorization: localStorage.getItem("accessToken"),
              },
            };

            fetch(
              `https://task-management-rest-app.herokuapp.com/api/tasks/${Id}`,
              configPut
            )
              .then((res) => res.json())
              .then((data) => {
                setTimeout(alert("Task Updated"), 1000);
                console.log(data);
                removels();
                document.getElementById("form").reset();
                remove_valid_class();
              });
          }
        }
      }
      function removeUserInfo() {
        localStorage.removeItem("accessToken");
        localStorage.removeItem("email");
        localStorage.removeItem("firstName");
        localStorage.removeItem("lastName");
        localStorage.removeItem("userId");
      }

      function error(field, para) {
        field.classList.add("is-invalid");
        para.style.visibility = "visible";
      }
      function valid(field, para) {
        field.classList.remove("is-invalid");
        field.classList.add("is-valid");
        para.style.visibility = "hidden";
      }
      function remove_valid_class() {
        title.classList.remove("is-valid");
        des.classList.remove("is-valid");
        due.classList.remove("is-valid");
        priority.classList.remove("is-valid");
      }
    </script>
  </body>
</html>
